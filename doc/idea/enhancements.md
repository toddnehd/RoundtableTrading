# 멀티 에이전틱 주식 트레이딩 서비스 - 개선 및 보완 사항

> 이 문서는 beginning-idea.md와 brainstorming.md를 검토한 후 도출된 추가 아이디어, 구현 가능성 분석, 개선 방안을 정리한 문서입니다.

**작성일**: 2026-01-27

---

## 1. 추가 에이전트 제안

### 1.1 타임프레임별 전략 분리 에이전트

**문제 인식**:
- 현재 에이전트들은 분야(기술적/펀더멘털/심리 등)로만 분류
- 시간축에 대한 고려 부족
- 같은 종목이라도 "데이트레이딩"과 "3개월 스윙"은 완전히 다른 판단 필요

**제안 구조**:
```
타임프레임 전략 에이전트
├─ 초단기 (데이트레이딩): 1일 이내
├─ 단기 (스윙): 3~10일
├─ 중기 (포지션): 1~3개월
└─ 장기 (투자): 3개월 이상
```

**역할**:
- 조정자가 타임프레임을 먼저 결정
- 해당 타임프레임에 맞는 에이전트 가중치 자동 조정
  - 예: 데이트레이딩 → 기술적 분석 가중치 ↑, 펀더멘털 가중치 ↓
  - 예: 장기 투자 → 펀더멘털 가중치 ↑, 기술적 분석 가중치 ↓

**구현 고려사항**:
- 사용자가 선호하는 타임프레임 설정 가능
- 각 타임프레임별 성과를 별도 추적
- 복수 타임프레임 동시 운영 가능 (자금 분할)

---

### 1.2 반대 포지션 전담 에이전트 (Devil's Advocate)

**문제 인식**:
- 현재 토론 구조에서 **집단 사고(Groupthink)** 위험
- 다수 에이전트가 같은 방향으로 기울면 반대 논리 부족
- 합의가 너무 쉽게 이루어질 경우 위험

**역할**:
- 의도적으로 반대 논리를 펼치는 에이전트
- 다수의 에이전트가 "매수"로 기울면, 이 에이전트가 "매도 논리"를 의무적으로 제시
- 다수의 에이전트가 "매도"로 기울면, "매수 논리"를 제시

**핵심 기능**:
- 다수 의견의 약점 분석
- "이 판단이 틀릴 수 있는 시나리오" 제시
- 간과된 리스크 요소 발굴
- 역사적 유사 사례에서 실패한 케이스 제시

**가중치 전략**:
- 합의도가 높을수록(예: 90% 이상) → Devil's Advocate 가중치 증가
- 합의도가 낮을수록(예: 60% 미만) → Devil's Advocate 가중치 감소

**예시 시나리오**:
```
8개 에이전트가 "삼성전자 매수(평균 88점)" 합의
→ Devil's Advocate:
  "반대 의견 (55점): 
   1. RSI 70 돌파로 단기 과열 가능성
   2. 미국 반도체 규제 리스크
   3. 과거 유사 패턴에서 조정 확률 65%
   → 진입 시점 재검토 필요"
```

---

### 1.3 유동성 분석 에이전트

**문제 인식**:
- 한국 시장 특성상 소형주의 유동성이 매우 낮음
- 대량 매수 시 시장 충격(Market Impact) 발생
- 현재 구조에서 유동성 고려 부재

**역할**:
- 실시간 유동성 평가
- 주문 시 시장 충격 추정
- 포지션 크기 제한 제안

**핵심 지표**:
- 일평균 거래량 대비 주문량 비율
- 호가창 두께 (매수/매도 호가 잔량)
- 스프레드 크기 (매수/매도 호가 차이)
- 체결 강도 (거래량 증가 추세)

**출력 예시**:
```
종목: ABC기업
일평균 거래량: 100,000주
현재 호가 스프레드: 0.5% (넓음)
추천 최대 포지션: 5,000주 (일거래량의 5%)
예상 시장 충격: 0.3% 가격 상승
분할 매수 권장: 3회 (각 1,700주)
```

**Phase별 중요도**:
- Phase 1: 낮음 (분석만 제공)
- Phase 2: 중간 (소액이므로 큰 문제 없음)
- Phase 3: **매우 높음** (대량 매매 시 필수)

---

## 2. 에이전트 성과 관리 시스템

### 2.1 ELO 레이팅 시스템

**개념**:
- 체스 레이팅처럼 에이전트 간 예측 정확도를 상대 평가
- 단순 승률이 아닌, "얼마나 어려운 예측을 맞췄는가"를 반영

**작동 방식**:
```python
# 예시 알고리즘
def update_elo(agent_elo, prediction_correct, difficulty):
    expected_score = 1 / (1 + 10 ** ((difficulty - agent_elo) / 400))
    actual_score = 1 if prediction_correct else 0
    new_elo = agent_elo + K * (actual_score - expected_score)
    return new_elo
```

**적용 사례**:
- 모든 에이전트가 "매수"라고 한 종목이 상승 → ELO 변화 적음
- 대부분이 "매도"였지만 특정 에이전트만 "매수"를 주장하고 맞음 → ELO 큰 폭 상승

**장점**:
- 에이전트의 "독립적 판단 능력" 평가
- 추종자(Follower)와 선도자(Leader) 구분 가능

---

### 2.2 계절적/시장 환경별 가중치

**문제 인식**:
- 특정 에이전트는 상승장에서 강하고, 다른 에이전트는 하락장에서 강함
- 단일 가중치로는 이를 반영 불가

**제안 구조**:
```
에이전트별 성과 기록
├─ 상승장 (KOSPI +2% 이상/월)
├─ 하락장 (KOSPI -2% 이하/월)
├─ 횡보장 (KOSPI ±2% 이내/월)
├─ 변동성 높음 (VIX 상위 25%)
└─ 변동성 낮음 (VIX 하위 25%)
```

**적용 방법**:
1. 현재 시장 환경 자동 감지
2. 해당 환경에서 과거 성과가 좋은 에이전트의 가중치 증가
3. 매주 시장 환경 재평가 및 가중치 조정

**예시**:
```
현재 시장 상태: 하락장 + 변동성 높음
→ 리스크 관리 에이전트 가중치: 1.0 → 1.5
→ 기술적 분석 에이전트 가중치: 1.2 → 1.0
→ 기업 가치 분석 에이전트 가중치: 1.0 → 0.8
```

---

### 2.3 자동 비활성화 (Cooling-off)

**원칙**:
- 성과가 지속적으로 나쁜 에이전트는 토론에서 일시 배제
- "쉬는 시간"을 통해 시스템 전체의 노이즈 감소

**조건**:
- 최근 20회 예측 중 승률 < 40%
- 최근 1개월 성과 < -10%
- 연속 5회 이상 오판

**비활성화 기간**:
- 1주일 휴지기 (토론 참여 불가, 관찰만)
- 재활성화 조건: 휴지기 동안 백테스팅에서 승률 > 55%

**예외**:
- 리스크 관리 에이전트는 절대 비활성화 불가 (안전장치)

---

## 3. 장 전/장 중/장 후 운영 루틴

### 3.1 장 전 루틴 (08:00 ~ 09:00)

**목표**: 금일 전략 수립 및 감시 종목 선정

**작업 순서**:
```
1. 해외 시장 분석 (30분)
   - 전일 미국 증시 (S&P 500, NASDAQ, DOW)
   - 미국 주요 종목 동향 (TSLA, NVDA, AAPL 등)
   - 환율 변동 (USD/KRW)
   - 국제 유가, 금 시세

2. 국내 뉴스 체크 (15분)
   - 주요 경제 뉴스
   - 정책 발표 (금리, 규제 등)
   - 주요 기업 공시

3. 감시 종목 리스트 생성 (15분)
   - 전일 급등/급락 종목
   - 거래량 급증 종목
   - 에이전트 추천 종목 (전날 저녁 분석)
   - 보유 종목 재평가

4. 금일 전략 브리핑
   - 시장 예상 방향 (상승/하락/횡보)
   - 주요 감시 섹터
   - 진입 대기 종목 (목표가 도달 시 매수)
   - 청산 대기 종목 (손절가/목표가 근접)
```

**출력물**:
- 금일 Top 10 감시 종목 리스트
- 각 종목별 진입가/손절가 사전 설정
- 시장 시나리오별 대응 전략

---

### 3.2 장 중 루틴 (09:00 ~ 15:30)

**목표**: 실시간 모니터링 및 신속한 의사결정

**Phase별 차이**:

| Phase | 방식 | 특징 |
|-------|------|------|
| Phase 1 | 관찰 + 알림 | 조건 충족 시 사용자에게 알림만 |
| Phase 2 | 알림 + 승인 대기 | 사용자 승인 후 자동 주문 |
| Phase 3 | 완전 자동 | 사전 승인된 범위 내 자율 실행 |

**실시간 모니터링 항목**:
- 감시 종목의 목표가 도달 여부
- 보유 종목의 손절가/목표가 도달 여부
- 급격한 시장 변동 (KOSPI ±1.5% 이상)
- 주요 뉴스 발생 (속보 크롤링)

**긴급 대응 프로토콜**:
```
시나리오 1: 보유 종목 손절가 도달
→ 즉시 매도 (사전 동의 시 자동 실행)

시나리오 2: 시장 급락 (KOSPI -2% 이상)
→ 방어 모드 전환
   - 신규 매수 중단
   - 손절가 타이트하게 조정 (-7% → -5%)
   - 현금 비중 증가

시나리오 3: 감시 종목 진입 신호
→ 에이전트 긴급 회의 (5분 이내)
→ 합의 시 주문 실행
```

**장중 토론의 제약**:
- LLM 호출 레이턴시 고려 (1-5초/호출)
- 9개 에이전트 전체 토론은 **비현실적** (시간 소요 과다)
- **해결책**: 
  - 규칙 기반 1차 판단 (Python 코드)
  - 임계값 근접 시에만 조정자 개입
  - 긴급 상황 시 3개 핵심 에이전트만 소집

---

### 3.3 장 후 루틴 (15:30 ~ 18:00)

**목표**: 금일 복기 및 익일 전략 준비

**작업 순서**:
```
1. 성과 기록 및 분석 (30분)
   - 금일 매매 내역
   - 손익 계산 (실현 손익 + 평가 손익)
   - 승률, 손익비
   - 포트폴리오 변동

2. 에이전트 평가 (30분)
   - 각 에이전트의 금일 예측 정확도
   - ELO 레이팅 업데이트
   - 가중치 조정

3. 심층 종목 분석 (60분)
   - LLM 기반 전체 에이전트 토론 (시간 제약 없음)
   - 신규 후보 종목 발굴 (30~50개)
   - 각 종목별 종합 리포트 생성

4. 익일 전략 수립 (30분)
   - 시장 예측 (해외 선물 지수 참고)
   - 감시 종목 1차 선정
   - 포트폴리오 리밸런싱 계획

5. 사용자 리포트 생성 (30분)
   - 금일 성과 요약
   - 주요 의사결정 과정 기록
   - 익일 전략 브리핑
   - 에이전트 토론 하이라이트
```

**출력물**:
- 일일 성과 리포트 (PDF 또는 웹 대시보드)
- 익일 Top 10 후보 종목
- 각 종목별 에이전트 토론 요약

---

## 4. 비용 최적화 전략

### 4.1 문제의 심각성

**예상 비용 계산**:
```
가정:
- 분석 종목: 50개/일
- 에이전트 수: 9개
- 토론 라운드: 3회
- API 호출: 50 × 9 × 3 = 1,350회/일

Claude API 비용 (예시):
- Input: $3/M tokens, Output: $15/M tokens
- 평균 호출당 2K input + 500 output tokens
- 일일 비용: 1,350 × (2K×$3 + 0.5K×$15) / 1M = $18.23
- 월간 비용 (20거래일): $364.6

→ Phase 3에서 사용자 100명 가정 시 월 $36,460 (약 5천만원)
```

**결론**: 현재 구조 그대로는 **경제적으로 지속 불가능**

---

### 4.2 2단계 스크리닝 아키텍처

**핵심 아이디어**:
- 1차: 규칙 기반 필터링 (LLM 없이, 비용 0)
- 2차: LLM 기반 심층 분석 (소수 종목만)

**구조**:
```
전체 종목 (2,000개)
      ↓
┌─────────────────────────────────────┐
│ 1차 스크리닝 (규칙 기반)             │
│ - Python 코드로 기술적 지표 계산     │
│ - 거래량/거래대금 필터               │
│ - PER, PBR 등 재무 지표 필터         │
│ - 뉴스 키워드 매칭                   │
│ 소요 시간: 5분                       │
│ 비용: $0                            │
└─────────────────────────────────────┘
      ↓
후보 종목 (100개)
      ↓
┌─────────────────────────────────────┐
│ 2차 스크리닝 (경량 LLM)              │
│ - GPT-3.5 또는 Claude Haiku          │
│ - 단일 에이전트 빠른 평가            │
│ - 점수화 (0-100)                    │
│ 소요 시간: 10분                      │
│ 비용: ~$2/일                        │
└─────────────────────────────────────┘
      ↓
최종 후보 (10~20개)
      ↓
┌─────────────────────────────────────┐
│ 3차 심층 분석 (전체 에이전트 토론)   │
│ - Claude Sonnet (9개 에이전트)       │
│ - 3라운드 토론                       │
│ - 종합 리포트 생성                   │
│ 소요 시간: 30분                      │
│ 비용: ~$5/일                        │
└─────────────────────────────────────┘
      ↓
최종 추천 (3~5개)
```

**비용 절감 효과**:
- 기존: $18.23/일 → 개선 후: $7/일 (**60% 절감**)

---

### 4.3 에이전트별 LLM 티어링

**개념**:
- 모든 에이전트가 Claude Sonnet을 쓸 필요 없음
- 복잡도에 따라 다른 모델 할당

**티어 구조**:

| 에이전트 | 사용 모델 | 이유 |
|---------|----------|------|
| 기술적 분석 | **규칙 기반** (Python) | 지표 계산은 수식이므로 LLM 불필요 |
| 유동성 분석 | **규칙 기반** (Python) | 수치 계산만 필요 |
| 뉴스 감성 분석 | GPT-3.5 Turbo | 간단한 감성 분류 |
| 심리 분석 | Claude Haiku | 중간 수준 추론 |
| 이벤트 트래커 | Claude Haiku | 공시 요약 및 분류 |
| 기업 가치 분석 | **Claude Sonnet** | 복잡한 재무 분석 필요 |
| 시장 분석 | **Claude Sonnet** | 거시 경제 추론 |
| 리스크 관리 | **Claude Sonnet** | 고도의 판단 필요 |
| 조정자 | **Claude Sonnet** | 최종 의사결정 |

**추가 절감 효과**: 약 30% 추가 절감

---

### 4.4 캐싱 및 배치 처리

**전략 1: 프롬프트 캐싱**
- Claude API는 프롬프트 캐싱 지원
- 에이전트의 시스템 프롬프트는 매번 동일 → 캐싱 가능
- 비용 절감: 약 90% (캐싱된 부분에 대해)

**전략 2: 배치 처리**
- 장 후 루틴에서 50개 종목을 순차 처리하지 않고 배치로 묶음
- 일부 LLM은 배치 API 제공 시 할인

**전략 3: 결과 재사용**
- 동일 종목에 대한 펀더멘털 분석은 1일 1회만 (장 후)
- 장 중에는 기술적 지표만 업데이트 (규칙 기반)

---

## 5. 합의 실패 시나리오 정교화

### 5.1 현재 문제점

brainstorming.md에서:
> "합의 실패 시 → '판단 보류' 또는 '소량 진입'"

**부족한 점**:
- 합의 실패 빈도가 높으면? → 실질적으로 아무것도 못 함
- 부분적 합의 (일부는 찬성, 일부는 반대) 처리 방법 불명확
- 임계값(70%)의 적정성 검증 방법 없음

---

### 5.2 개선된 합의 알고리즘

**3단계 합의 수준**:

| 합의도 | 범위 | 조치 |
|--------|------|------|
| **강한 합의** | ≥ 80% | 표준 포지션 (자산의 15~20%) |
| **약한 합의** | 60~79% | 축소 포지션 (자산의 5~10%) + 타이트한 손절 |
| **합의 실패** | < 60% | 판단 보류 또는 관찰 리스트 등록 |

**부분 합의 처리**:
```
예시: 삼성전자 분석 결과
- 기술적/시장/심리/이벤트: 매수 (평균 85점)
- 기업가치: 중립 (60점)
- 리스크관리: 매도 (40점)

→ 가중 평균: 72점 (약한 합의)
→ 조치: 
   - 포지션 크기: 10% (표준 15%의 2/3)
   - 손절가: -5% (표준 -7%보다 타이트)
   - 재평가 주기: 2일 (표준 5일보다 짧음)
```

---

### 5.3 동적 임계값 조정

**문제 인식**:
- 시장 환경에 따라 적절한 임계값이 다름
- 변동성 높은 시장: 더 높은 합의도 필요
- 안정적인 시장: 낮은 합의도도 허용 가능

**제안 알고리즘**:
```python
def get_threshold(market_volatility, portfolio_drawdown):
    base_threshold = 70
    
    # 변동성 조정 (VIX 기준)
    if market_volatility > 30:  # 높은 변동성
        base_threshold += 10
    elif market_volatility < 15:  # 낮은 변동성
        base_threshold -= 5
    
    # 손실 상황 조정
    if portfolio_drawdown > 10:  # 10% 이상 손실
        base_threshold += 15  # 더 신중하게
    
    return min(base_threshold, 90)  # 최대 90%
```

**효과**:
- 위험 상황: 임계값 상승 → 더 확실한 경우만 진입
- 안정 상황: 임계값 하락 → 기회 포착 확률 증가

---

### 5.4 관찰 리스트 시스템

**목적**: 합의 실패 종목을 버리지 않고 추적

**작동 방식**:
```
합의 실패 (50~59%) 종목
    ↓
관찰 리스트 등록
    ↓
매일 재평가 (경량 분석)
    ↓
조건 변화 감지
    ↓
재토론 트리거
```

**재토론 조건**:
- 가격 ±5% 이상 변동
- 거래량 평소의 2배 이상
- 주요 뉴스 발생
- 3거래일 경과

**예시**:
```
1/27: 삼성전자 분석 → 합의도 58% (실패)
      → 관찰 리스트 등록

1/28: 가격 변동 없음 → 경량 체크만

1/29: 거래량 급증 + 뉴스 발생
      → 재토론 트리거
      → 새로운 합의도: 78%
      → 매수 진행
```

---

## 6. 데이터 품질 및 전처리

### 6.1 현재 문제점

brainstorming.md에서 데이터 소스는 명시되어 있으나:
- 데이터 품질 검증 방법 없음
- 결측치/이상치 처리 전략 없음
- 데이터 지연 처리 방법 불명확

---

### 6.2 데이터 소스별 전략

#### pykrx (과거 데이터)

**장점**:
- 무료
- 과거 데이터 풍부
- Python 친화적

**단점**:
- 크롤링 기반 → 웹사이트 구조 변경 시 오류
- 실시간 데이터 없음
- 일부 데이터 지연 (1~2일)

**대응 전략**:
```python
# 데이터 검증 파이프라인
def validate_pykrx_data(df):
    issues = []
    
    # 1. 결측치 확인
    if df.isnull().sum().sum() > 0:
        issues.append("결측치 발견")
    
    # 2. 가격 이상치 확인 (전일 대비 ±30% 이상)
    price_change = df['종가'].pct_change()
    if (price_change.abs() > 0.3).any():
        issues.append("가격 급변 감지")
    
    # 3. 거래량 0 확인 (정지 종목)
    if (df['거래량'] == 0).any():
        issues.append("거래량 0 (정지 종목 가능성)")
    
    # 4. 중복 데이터 확인
    if df.duplicated(subset=['날짜']).any():
        issues.append("중복 데이터")
    
    return len(issues) == 0, issues
```

---

#### 증권사 OpenAPI (실시간 데이터)

**장점**:
- 실시간 시세
- 정확도 높음
- 주문 실행 가능

**단점**:
- 호출 제한 (초당 5~10회)
- Windows 전용인 경우 많음
- 일부 유료

**선택 가이드**:

| 증권사 | API 타입 | 플랫폼 | 추천도 |
|--------|----------|--------|--------|
| 한국투자증권 | REST API | 크로스 플랫폼 | ⭐⭐⭐⭐⭐ |
| 키움증권 | COM/ActiveX | Windows 전용 | ⭐⭐⭐ |
| 이베스트투자증권 | REST API | 크로스 플랫폼 | ⭐⭐⭐⭐ |

**권장**: 한국투자증권 REST API

---

#### DART OpenAPI (재무제표)

**목적**: 기업 공시, 재무제표 수집

**활용**:
- 분기/연간 실적 발표
- 공시 실시간 모니터링 (유상증자, M&A 등)
- 사업보고서 텍스트 분석

**구현 예시**:
```python
import OpenDartReader

dart = OpenDartReader(api_key='YOUR_API_KEY')

# 삼성전자 재무제표
df = dart.finstate('005930', 2024)

# 주요 공시 실시간 조회
disclosures = dart.list(corp='삼성전자', start='2024-01-01')
```

---

#### 뉴스 크롤링 (법적 이슈 주의)

**주의사항**:
- 네이버 증권, 다음 증권: 크롤링 약관 위반 가능성
- robots.txt 확인 필수
- 과도한 요청 시 IP 차단

**대안**:
1. **공식 API 사용**: 네이버 뉴스 API, 구글 뉴스 API
2. **RSS 피드 활용**: 주요 언론사 RSS
3. **제휴**: 뉴스 제공 업체와 제휴 (유료)

**권장 솔루션**:
```
Phase 1-2: RSS + 공식 API (무료)
Phase 3: 뉴스 제공 업체 제휴 (예: 뉴스핌, 연합인포맥스)
```

---

### 6.3 결측치 처리 전략

**상황별 처리**:

| 데이터 | 결측치 발생 시 | 처리 방법 |
|--------|---------------|-----------|
| 주가 | 상장 폐지, 거래 정지 | 해당 종목 분석 제외 |
| 재무제표 | 아직 발표 안 됨 | 직전 분기 데이터 사용 (outdated 표시) |
| 거래량 | 시스템 오류 | 전후 평균으로 보간 |
| 뉴스 | 크롤링 실패 | 해당 일자 감성 점수 중립(50점) 처리 |

**원칙**:
- **절대 임의 데이터로 채우지 않음**
- 결측치 발생 시 명확히 기록
- 사용자에게 불확실성 전달

---

## 7. 에이전트 프롬프트 설계 원칙

### 7.1 할루시네이션 방지

**문제 시나리오**:
```
사용자: "삼성전자의 PER을 분석해줘"
LLM (잘못된 답): "삼성전자의 PER은 25입니다" (실제 15)
→ 잘못된 데이터 기반 투자 결정 → 손실
```

**핵심 원칙**:
> **LLM은 해석만, 데이터는 Tool에서**

**올바른 구조**:
```python
# WRONG: LLM이 데이터를 기억에 의존
prompt = "삼성전자의 PER을 분석해줘"

# CORRECT: Tool로 데이터 제공 후 해석만 요청
tools = [get_financial_data]
data = get_financial_data("005930")  # PER: 15.2
prompt = f"""
다음 재무 데이터를 분석하세요:
- 종목: 삼성전자 (005930)
- PER: {data['PER']}
- PBR: {data['PBR']}
- ROE: {data['ROE']}

업종 평균 PER: 18.5

이 기업의 밸류에이션이 저평가인지 분석하세요.
"""
```

---

### 7.2 신뢰도 점수 일관성

**문제**:
- 에이전트마다 "85점"의 기준이 다를 수 있음
- 한 에이전트는 후하게, 다른 에이전트는 박하게 채점

**해결책: 점수 가이드라인 명시**

```
에이전트 프롬프트에 포함:

신뢰도 점수 기준:
- 90~100점: 매우 확실함. 과거 유사 패턴에서 승률 > 80%
- 75~89점: 확신함. 여러 근거가 일치.
- 60~74점: 약한 긍정. 일부 근거만 지지.
- 40~59점: 중립. 불확실함.
- 25~39점: 약한 부정.
- 10~24점: 부정적. 여러 근거가 반대.
- 0~9점: 매우 부정적. 명확한 리스크.

예시:
- "PER 10으로 저평가 + 골든크로스 + 외국인 순매수" → 85점
- "PER 10으로 저평가지만 실적 악화 우려" → 55점
```

---

### 7.3 에이전트별 프롬프트 템플릿

#### 기술적 분석 에이전트
```
당신은 기술적 분석 전문가입니다.

역할:
- 차트 패턴, 기술적 지표, 거래량 분석
- 단기 가격 움직임 예측

사용 가능한 데이터:
{chart_data}
{indicators}

분석 시 고려사항:
1. 여러 지표의 종합 판단 (단일 지표에 의존 금지)
2. 과거 유사 패턴의 성공률
3. 현재 시장 변동성

출력 형식:
- 의견: 매수/중립/매도
- 신뢰도: 0-100점 (기준 준수)
- 핵심 근거 3개 (간결하게)
```

#### 리스크 관리 에이전트
```
당신은 리스크 관리 전문가입니다.

역할:
- 포트폴리오 위험도 평가
- 손절 판단
- 포지션 크기 제안

현재 포트폴리오:
{portfolio}

분석 대상 종목:
{stock_data}

분석 시 고려사항:
1. 이 종목 추가 시 섹터 집중 리스크
2. 변동성 (베타)
3. 유동성
4. 전체 포트폴리오 MDD 영향

출력 형식:
- 최대 포지션 크기: X%
- 권장 손절가: -Y%
- 리스크 점수: 0-100점 (낮을수록 안전)
```

---

## 8. 추가 고려사항

### 8.1 모바일 알림 시스템

**필요성**:
- 장중 중요 이벤트 발생 시 사용자에게 즉시 알림
- 웹 대시보드만으로는 부족

**옵션**:

| 방법 | 장점 | 단점 |
|------|------|------|
| 텔레그램 봇 | 구현 쉬움, 무료 | 텔레그램 사용자만 |
| 카카오톡 알림 | 한국 사용자 많음 | 유료 (비즈니스 계정) |
| FCM (Firebase) | 앱 푸시 가능 | 앱 개발 필요 |
| 이메일 | 보편적 | 실시간성 떨어짐 |

**권장**:
- Phase 1-2: 텔레그램 봇 (빠른 구현)
- Phase 3: 카카오톡 알림 추가

---

### 8.2 Paper Trading vs 실전의 Gap

**문제**:
- 시뮬레이션에서 100% 수익 → 실전에서 손실
- 슬리피지, 체결 지연, 호가 갭 등 현실 요소

**정확한 Paper Trading 구현**:

```python
class RealisticSimulator:
    def execute_order(self, ticker, quantity, order_type):
        # 1. 슬리피지 적용
        slippage = self.calculate_slippage(quantity, ticker)
        
        # 2. 체결 지연 시뮬레이션 (1~3초)
        execution_delay = random.uniform(1, 3)
        price_at_execution = self.get_price_after_delay(
            ticker, execution_delay
        )
        
        # 3. 부분 체결 시뮬레이션 (유동성 부족 시)
        if self.is_illiquid(ticker):
            quantity = self.partial_fill(quantity, ticker)
        
        # 4. 수수료 및 세금
        commission = quantity * price_at_execution * 0.00015
        tax = quantity * price_at_execution * 0.0023 if is_sell else 0
        
        total_cost = quantity * price_at_execution + commission + tax
        
        return {
            'executed_quantity': quantity,
            'execution_price': price_at_execution,
            'total_cost': total_cost
        }
```

---

### 8.3 규제 및 법적 이슈

**자동매매 규제 (한국)**:
- 개인 투자자의 자동매매는 **합법**
- 단, 불공정거래 (시세조종, 허위 정보 유포 등)는 불법

**투자 조언 규제**:
- "투자 조언"으로 간주될 경우 금융투자업 등록 필요
- 면책 조항 필수

**권장 면책 조항**:
```
본 서비스는 투자 참고 자료일 뿐, 투자 조언이 아닙니다.
모든 투자 결정은 사용자 본인의 책임입니다.
투자 손실에 대해 서비스 제공자는 책임지지 않습니다.
```

**개인정보 보호**:
- 계좌 정보, 거래 내역: 암호화 저장 필수
- HTTPS 통신
- 정기적인 보안 감사

---

## 9. 우선순위 정리

| 우선순위 | 항목 | Phase | 이유 |
|---------|------|-------|------|
| **P0** | 2단계 스크리닝 아키텍처 | 1 | 비용 절감의 핵심 |
| **P0** | 에이전트 프롬프트 + 할루시네이션 방지 | 1 | 잘못된 데이터는 치명적 |
| **P0** | 한국투자증권 API 연동 | 1 | 실시간 데이터 필수 |
| **P1** | 장 전/장 중/장 후 루틴 구현 | 1-2 | 실전 운영의 뼈대 |
| **P1** | 합의 실패 시나리오 정교화 | 2 | 실전에서 자주 발생 |
| **P1** | ELO 레이팅 + 가중치 시스템 | 2 | 학습 능력의 핵심 |
| **P2** | Devil's Advocate 에이전트 | 2 | Groupthink 방지 |
| **P2** | 타임프레임별 전략 분리 | 2-3 | 다양한 전략 지원 |
| **P2** | 텔레그램 알림 | 1-2 | 사용자 편의성 |
| **P3** | 유동성 분석 에이전트 | 3 | 대량 매매 시 중요 |
| **P3** | 계절적 가중치 시스템 | 3 | 고도화 기능 |

---

## 10. 다음 단계 제안

### 즉시 결정 필요 (이번 주)
1. ✅ **증권사 API 선택**: 한국투자증권 REST API
2. ⏳ **에이전트 프레임워크**: 
   - Phase 1: 직접 구현 (Python + async)
   - Phase 2 이후: 필요 시 LangGraph 도입
3. ⏳ **MVP 범위 확정**:
   - 필수: 기술적 분석 + 기업 가치 분석 + 리스크 관리 (3개)
   - 옵션: 시장 분석 (나중에 추가)

### 단기 (1~2주)
1. **PRD 작성**: 3개 문서 통합
2. **Architecture 상세 설계**: 
   - 2단계 스크리닝 구조
   - 에이전트 프롬프트 템플릿
3. **데이터 파이프라인 PoC**:
   - pykrx 데이터 수집 테스트
   - 한국투자증권 API 연동 테스트
   - 데이터 검증 로직 구현

### 중기 (1개월)
1. **Phase 1 MVP**:
   - 단일 종목 분석 시스템
   - 3개 에이전트 협업 (기술적/펀더멘털/리스크)
   - 토론 과정 시각화 (간단한 텍스트 출력)
2. **백테스팅 엔진**:
   - 현실적 비용 반영
   - 과거 1년 데이터로 검증

---

**문서 버전**: v1.0  
**최종 업데이트**: 2026-01-27  
**다음 리뷰 예정**: PRD 작성 후
